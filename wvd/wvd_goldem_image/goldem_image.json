{
    "_comment1": "GOLDEM IMAGE - Windows 10 Multiuser Office 365 Pro Plus From Marketplace",
    "variables": {
        "azure-subscription-id": "{{env `MY_AZURE_SUBSCRIPTION_ID`}}",
        "azure-client-id": "{{env `MY_AZURE_CLIENT_ID`}}",
        "azure-secret": "{{env `MY_AZURE_SECRET`}}",
        "azure-tenant-id": "{{env `MY_AZURE_TENANT`}}",
        "image-rg": "rg-sig",
        "azure-region": "eastus2",
        "vm-size": "Standard_B8MS"
    },
    "_comment2": "CREATE CUSTOM IMAGE",
    "builders": [
        {
            "type": "azure-arm",
            "client_id": "{{user `azure-client-id`}}",
            "client_secret": "{{user `azure-secret`}}",
            "tenant_id": "{{user `azure-tenant-id`}}",
            "subscription_id": "{{user `azure-subscription-id`}}",
            "managed_image_resource_group_name": "{{user `image-rg`}}",
            "managed_image_name": "Windows10_o365pp-{{timestamp}}",
            "virtual_network_resource_group_name": "RG-NETWORKS",
            "virtual_network_name": "VN-FAILOVER",
            "virtual_network_subnet_name": "SN-FAILOVER",
            "private_virtual_network_with_public_ip": "true",
            "os_type": "Windows",
            "image_publisher": "MicrosoftWindowsDesktop",
            "image_offer": "office-365",
            "image_sku": "20h2-evd-o365pp",
            "boot_diag_storage_account": "cloudshell2512",
            "communicator": "winrm",
            "winrm_use_ssl": true,
            "winrm_insecure": true,
            "winrm_timeout": "5m",
            "winrm_username": "packer",
            "location": "{{user `azure-region`}}",
            "vm_size": "{{user `vm-size`}}",
            "azure_tags": {
                "WVD": "WindowsVirtualDesktop"
            }
        }
    ],
    "_comment3": "INSTALL UPDATES and SOFTWARES",
    "provisioners": [
        {
            "type": "powershell",
            "inline": [
                "  while ((Get-Service RdAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
                "  while ((Get-Service WindowsAzureGuestAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
                "Set-ExecutionPolicy Bypass -Scope Process -Force",
                "New-Item -Path 'C:\\temp' -ItemType Directory -Force | Out-Null"
            ]
        },
        {
            "type": "powershell",
            "script": ".\\OneDrive.ps1"
        },
        {
            "type": "powershell",
            "script": ".\\script_apps_install.ps1"
        },
        {
            "type": "powershell",
            "script": ".\\OptimizeWVD.ps1"
        },
        {
            "type": "windows-restart",
            "restart_check_command": "powershell -command \"&amp; {Write-Output 'Machine Restarting.'}\""
        },
        {
            "type": "powershell",
            "inline": [
                "  while ((Get-Service RdAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
                "  while ((Get-Service WindowsAzureGuestAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
                "Write-Host \"`nListing Softwares Installed...\"",
                "Get-ItemProperty HKLM:\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\* | Select-Object DisplayName, DisplayVersion, Publisher, InstallDate | Format-Table â€“AutoSize",
                "Write-Host \"`nDoing Sysprep...\"",
                "& Remove-Item -Path $env:SystemRoot\\Panther -Confirm:$false -Force -Recurse",
                "& $env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit /mode:vm",
                "while($true) { $imageState = Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\State | Select ImageState; if($imageState.ImageState -ne 'IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE') { Write-Output $imageState.ImageState; Start-Sleep -s 10  } else { break } }"
            ]
        }
    ]
}