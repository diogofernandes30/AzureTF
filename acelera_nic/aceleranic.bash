#!/bin/bash
#####   NOME:               aceleranic.bash
#####   VERSÃO:             1.0
#####   DESCRIÇÃO:          Script para habilitar a aceleração de rede em uma VM Azure.
#####   DATA DA CRIAÇÃO:    30/09/2020
#####   ESCRITO POR:        Diogo Fernandes
#####   E-MAIL:             dfs@outlook.com.br
#####   DISTRO:             Windows/Linux
#####   USO:                ./acelera_nic.bash VMNAME

VM="$1"
RG=`az vm list --query '[].{Name:name,RG:resourceGroup}' --output tsv  | grep -iw $VM | awk -F ' ' '{print $2}'`
SIZE=`az vm show -g $RG -n $VM --query 'hardwareProfile.vmSize' -o tsv`
NICNAME=`az vm show -g $RG -n $VM --query 'networkProfile.networkInterfaces[].id' -o tsv | awk -F '/' '{ print $9}'`
NICID=`az vm show -g $RG -n $VM --query 'networkProfile.networkInterfaces[].id' -o tsv`
ACC_TRUE=`az network nic show --ids $NICID --query 'enableAcceleratedNetworking' -o tsv`

for SIZES in Standard_D3_v2 Standard_D12_v2 Standard_D3_v2_Promo Standard_D12_v2_Promo Standard_DS3_v2 Standard_DS12_v2 Standard_DS13-4_v2 Standard_DS14-4_v2 Standard_DS3_v2_Promo Standard_DS12_v2_Promo Standard_DS13-4_v2_Promo Standard_DS14-4_v2_Promo Standard_F4 Standard_F4s Standard_D8_v3 Standard_D8s_v3 Standard_D32-8s_v3 Standard_E8_v3 Standard_E8s_v3 Standard_D3_v2_ABC Standard_D12_v2_ABC Standard_F4_ABC Standard_F8s_v2 Standard_D4_v2 Standard_D13_v2 Standard_D4_v2_Promo Standard_D13_v2_Promo Standard_DS4_v2 Standard_DS13_v2 Standard_DS14-8_v2 Standard_DS4_v2_Promo Standard_DS13_v2_Promo Standard_DS14-8_v2_Promo Standard_F8 Standard_F8s Standard_M64-16ms Standard_D16_v3 Standard_D16s_v3 Standard_D32-16s_v3 Standard_D64-16s_v3 Standard_E16_v3 Standard_E16s_v3 Standard_E32-16s_v3 Standard_D4_v2_ABC Standard_D13_v2_ABC Standard_F8_ABC Standard_F16s_v2 Standard_D5_v2 Standard_D14_v2 Standard_D5_v2_Promo Standard_D14_v2_Promo Standard_DS5_v2 Standard_DS14_v2 Standard_DS5_v2_Promo Standard_DS14_v2_Promo Standard_F16 Standard_F16s Standard_M64-32ms Standard_M128-32ms Standard_D32_v3 Standard_D32s_v3 Standard_D64-32s_v3 Standard_E32_v3 Standard_E32s_v3 Standard_E32-8s_v3 Standard_E32-16_v3 Standard_D5_v2_ABC Standard_D14_v2_ABC Standard_F16_ABC Standard_F32s_v2 Standard_D15_v2 Standard_D15_v2_Promo Standard_D15_v2_Nested Standard_DS15_v2 Standard_DS15_v2_Promo Standard_DS15_v2_Nested Standard_D40_v3 Standard_D40s_v3 Standard_D15_v2_ABC Standard_M64ms Standard_M64s Standard_M128-64ms Standard_D64_v3 Standard_D64s_v3 Standard_E64_v3 Standard_E64s_v3 Standard_E64-16s_v3 Standard_E64-32s_v3 Standard_F64s_v2 Standard_F72s_v2 Standard_M128s Standard_M128ms Standard_L8s_v2 Standard_L16s_v2 Standard_L32s_v2 Standard_L64s_v2 SQLGL SQLGLCore Standard_D4_v3 Standard_D4s_v3 Standard_D2_v2 Standard_DS2_v2 Standard_E4_v3 Standard_E4s_v3 Standard_F2 Standard_F2s Standard_F4s_v2 Standard_D11_v2 Standard_DS11_v2 AZAP_Performance_ComputeV17C AZAP_Performance_ComputeV17C_DDA AZAP_Performance_ComputeV17C_HalfNode Standard_PB6s Standard_PB12s Standard_PB24s Standard_L80s_v2 Standard_M8ms Standard_M8-4ms Standard_M8-2ms Standard_M16ms Standard_M16-8ms Standard_M16-4ms Standard_M32ms Standard_M32-8ms Standard_M32-16ms Standard_M32ls Standard_M32ts Standard_M64ls Standard_E64i_v3 Standard_E64is_v3 Standard_E4-2s_v3 Standard_E8-4s_v3 Standard_E8-2s_v3 Standard_E16-4s_v3 Standard_E16-8s_v3 Standard_E20s_v3 Standard_E20_v3 Standard_D11_v2_Promo Standard_D2_v2_Promo Standard_DS11_v2_Promo Standard_DS2_v2_Promo Standard_M208ms_v2 Standard_MDB16s Standard_MDB32s Experimental_E64-40s_v3 Standard_DS11-1_v2 Standard_DS12-1_v2 Standard_DS12-2_v2 Standard_DS13-2_v2 MSODSG5 Special_CCX_DS13_v2 Special_CCX_DS14_v2 F2_Flex F4_Flex F8_Flex F16_Flex F32_Flex F64_Flex F2s_Flex F4s_Flex F8s_Flex F16s_Flex F32s_Flex F64s_Flex D2_Flex D4_Flex D8_Flex D16_Flex D32_Flex D64_Flex D2s_Flex D4s_Flex D8s_Flex D16s_Flex D32s_Flex D64s_Flex E2_Flex E4_Flex E8_Flex E16_Flex E32_Flex E64_Flex E64i_Flex E2s_Flex E4s_Flex E8s_Flex E16s_Flex E32s_Flex E64s_Flex E64is_Flex Standard_M416ms_v2 Standard_M416s_v2 Standard_M208s_v2 FCA_E64-52s_v3 FCA_E32-28s_v3 FCA_E32-26s_v3 FCA_E32-24s_v3 FCA_E16-14s_v3 FCA_E16-12s_v3 FCA_E16-10s_v3 FCA_E8-6s_v3 Special_D4_v2 D48_Flex D48s_Flex E20_Flex E20s_Flex E48_Flex E48s_Flex F48s_Flex Standard_D48_v3 Standard_D48s_v3 Standard_E48_v3 Standard_E48s_v3 Standard_F48s_v2 Standard_L48s_v2 SQLG5_IaaS Standard_M128 Standard_M128m Standard_M64 Standard_M64m AZAP_Performance_ComputeV17C_12 Standard_B12ms Standard_B16ms Standard_B20ms SQLG5-80m AZAP_Performance_ComputeV17C_QuarterNode Standard_DS15i_v2 Standard_D15i_v2 Standard_F72fs_v2 AZAP_Performance_ComputeV17B_76 Standard_ND40s_v3 SQLG5_NP80 SQLG6 StandardM208msv2 SQLG6_IaaS SQLG7_AMD SQLG6_NP2 SQLG6_NP4 SQLG6_NP8 SQLG6_NP16 SQLG6_NP24 SQLG6_NP32 SQLG6_NP40 SQLG6_NP64 SQLG6_NP80 SQLG6_NP96 SQLG6_NP96s Standard_D4a_v3 Standard_D8a_v3 Standard_D16a_v3 Standard_D32a_v3 Standard_D48a_v3 Standard_D64a_v3 Standard_D96a_v3 Standard_D104a_v3 Standard_D4as_v3 Standard_D8as_v3 Standard_D16as_v3 Standard_D32as_v3 Standard_D48as_v3 Standard_D64as_v3 Standard_D96as_v3 Standard_D104as_v3 Standard_E4a_v3 Standard_E8a_v3 Standard_E16a_v3 Standard_E32a_v3 Standard_E48a_v3 Standard_E64a_v3 Standard_E96a_v3 Standard_E104a_v3 Standard_E4as_v3 Standard_E8as_v3 Standard_E16as_v3 Standard_E32as_v3 Standard_E48as_v3 Standard_E64as_v3 Standard_E96as_v3 Standard_E104as_v3 SQLG5_NP80s Standard_D4_v4 Standard_D8_v4 Standard_D16_v4 Standard_D32_v4 Standard_D48_v4 Standard_D64_v4 Standard_D4d_v4 Standard_D8d_v4 Standard_D16d_v4 Standard_D32d_v4 Standard_D48d_v4 Standard_D64d_v4 Standard_D4s_v4 Standard_D8s_v4 Standard_D16s_v4 Standard_D32s_v4 Standard_D48s_v4 Standard_D64s_v4 Standard_D4ds_v4 Standard_D8ds_v4 Standard_D16ds_v4 Standard_D32ds_v4 Standard_D48ds_v4 Standard_D64ds_v4 Standard_E4_v4 Standard_E8_v4 Standard_E16_v4 Standard_E20_v4 Standard_E32_v4 Standard_E48_v4 Standard_E64_v4 Standard_E4d_v4 Standard_E8d_v4 Standard_E16d_v4 Standard_E20d_v4 Standard_E32d_v4 Standard_E48d_v4 Standard_E64d_v4 Standard_E4s_v4 Standard_E8s_v4 Standard_E16s_v4 Standard_E20s_v4 Standard_Eandard_E20ds_v4 Standard_E32ds_v4 Standard_E48ds_v4 Standard_E64ds_v4 Standard_E64ids_v4 Standard_DC2s_v2 Standard_DC4s_v2 Standard_DC8_v2 SQLDCGen6_2 AZAP_Performance_ComputeV17W_76 AZAP_Performance_ComputeV17B_40 Standard_D4a_v4 Standard_D4as_v4 Standard_D8a_v4 Standard_D8as_v4 Standard_D16a_v4 Standard_D16as_v4 Standard_D32a_v4 Standard_D32as_v4 Standard_D48a_v4 Standard_D48as_v4 Standard_D64a_v4 Standard_D64as_v4 Standard_D96a_v4 Standard_D96as_v4 Standard_E4a_v4 Standard_E4as_v4 Standard_E8a_v4 Standard_E8as_v4 Standard_E16a_v4 Standard_E16as_v4 Standard_E20a_v4 Standard_E20as_v4 Standard_E32a_v4 Standard_E32as_v4 Standard_E48a_v4 Standard_E48as_v4 Standard_E64a_v4 Standard_E64as_v4 Standard_E96a_v4 Standard_E96as_v4 Standard_E64is_v4_SPECIAL Standard_E64ids_v4_SPECIAL Standard_E4-2s_v4 Standard_E8-2s_v4 Standard_E8-4s_v4 Standard_E16-8s_v4 Standard_E16-4s_v4 Standard_E32-16s_v4 Standard_E32-8s_v4 Standard_E64-32s_v4 Standard_E64-16s_v4 Standard_E4-2ds_v4 Standard_E8-4ds_v4 Standard_E8-2ds_v4 Standard_E16-8ds_v4 Standard_E16-4ds_v4 Standard_E32-16ds_v4 Standard_E32-8ds_v4 Standard_E64-32ds_v4 Standard_E64-16ds_v4 SQLG7 SQLG7_IaaS SQLG6_NP56 Experimental_Olympia20ls Experimental_Olympia20s Experimental_Olympia20ms Experimental_Olympia40ls Experimental_Olympia40s Experimental_Olympia40ms Experimental_Olympia72ls Experimental_Olympia72s Experimental_Olympia72ms Standard_E64i_v4_SPECIAL Experimental_OlympiaBTT20ls Experimental_OlympiaBTT20s Experimental_OlympiaBTT20ms Experimental_OlympiaBTT40ls Experimental_OlympiaBTT40s Experimental_OlympiaBTT40ms Experimental_OlympiaBTT72ls Experimental_OlympiaBTT72s Experimental_OlympiaBTT72ms SQLG7_NP4 SQLG7_NP8 SQLG7_NP16 SQLG7_NP24 SQLG7_NP32 SQLG7_NP40 SQLG7_NP64 SQLG7_NP80 SQLG7_NP96 SQLG7_NP104 SQLG7_NP104s Standard_M24s_v2 Standard_M24ms_v2 Standard_M48s_v2 Standard_M48ms_v2 Standard_M96s_v2 Standard_M96ms_v2 Standard_M192s_v2 Standard_M192ms_v2 Standard_D4hs_v3 Standard_D8hs_v3 Standard_D4ahs_v4 Standard_D8ahs_v4 AZAP_Performance_ComputeGen6_1_96 Experimental_F4ns_v2 Experimental_F8ns_v2 Experimental_F16ns_v2 Experimental_F32ns_v2 Experimental_F48ns_v2 Experimental_F64ns_v2 Experimental_F72ns_v2 Experimental_D4ns_v4 Experimental_D8ns_v4 Experimental_D16ns_v4 Experimental_D32ns_v4 Experimental_D48ns_v4 Experimental_E4ns_v4 Experimental_E8ns_v4 Experimental_E16ns_v4 Standard_E64id_v4_SPECIAL Experimental_UltraLocalDisk4 Experimental_UltraLocalDisk8 Experimental_UltraLocalDisk16 Experimental_UltraLocalDisk32 Experimental_UltraLocalDisk48 Experimental_UltraLocalDisk64 Experimental_UltraLocalDisk80 AZAP_Performance_ComputeV17W_38_HalfNode SQLG7_DCLK CosmosDBG5_JBOD Standard_M416xs_v2 Standard_M420xs_v2 Standard_M384xs_v2 Standard_M208-104ms_v2 Standard_M208-52ms_v2 Standard_M208-104s_v2 Standard_M208-52s_v2 Standard_M416-208ms_v2 Standard_M416-104ms_v2 Standard_M416-208s_v2 Standard_M416-104s_v2 AZAP_Performance_ComputeIntelGen7_0B_100 AZAP_Performance_ComputeIntelGen7_0CFpga_100 Standard_NV4as_v4 Standard_NV8as_v4 Standard_NV16as_v4 Standard_NV32as_v4 Standard_NV4ahs_v4 Standard_NV8ahs_v4 Standard_NV16ahs_v4 Standard_NV32ahs_v4 Standard_E80ids_v4 Standard_L88is_v2 Standard_M352xs_v2; do
    if [[ "$SIZE" == "$SIZES" ]]; then
        found=1
        break
    fi
done

if [[ "$found" -eq 1 ]]; 
  then
      if [[ $ACC_TRUE != "true" ]];
        then
          echo "SIZE ( $SIZE ) COMPATIVEL PARA ACELERAÇÃO DE REDE"
          echo -e "IMPORTANTE: A VM SERÁ DESLIGADA PARA ATUALIZAÇÃO DA NIC, DESEJA CONTINUAR?\n"
            select yn in "Yes" "No"; do
              case $yn in
                  Yes )  
                        echo "Desligando VM....................:" $VM
                            az vm deallocate --resource-group $RG --name $VM
                        echo "Habilitando Aceleração na Nic....:" $NICNAME
                            az network nic update --name $NICNAME --resource-group $RG --accelerated-networking true
                        echo "Ligando a VM.....................:" $VM
                            az vm start --resource-group $RG --name $VM
                      break;;
                  No ) 
                  exit;;
              esac
            done
        else
          echo -e "NIC ( $NICNAME ) JA ESTA ACELERADA\n"
        fi
      else 
          echo -e "SIZE NAO COMPATIVEL: ( $SIZE ) \n"
fi